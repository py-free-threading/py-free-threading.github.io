
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../porting/">
      
      
        <link rel="next" href="../dependencies/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Updating Extension Modules - Python Free-Threading Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#updating-extension-modules" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Free-Threading Guide" class="md-header__button md-logo" aria-label="Python Free-Threading Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Free-Threading Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Updating Extension Modules
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Free-Threading Guide" class="md-nav__button md-logo" aria-label="Python Free-Threading Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Python Free-Threading Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compatibility Status Tracking
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installing-cpython/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing Free-Threaded Python
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-gil-disabled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Python with the GIL Disabled
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../examples/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Usage Examples
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Usage Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/mandelbrot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mandelbrot Set Visualization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/monte-carlo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multithreaded Monte Carlo Simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/asyncio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Scraping with asyncio
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Porting Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Porting Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../porting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Porting Python Packages to Support Free-Threading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Updating Extension Modules
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Updating Extension Modules
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declaring-free-threaded-support" class="md-nav__link">
    <span class="md-ellipsis">
      Declaring free-threaded support
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-the-free-threaded-cpython-interpreter-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Working with the free-threaded CPython interpreter runtime
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#porting-c-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Porting C Extensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locking-and-synchronization-primitives" class="md-nav__link">
    <span class="md-ellipsis">
      Locking and Synchronization Primitives
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Locking and Synchronization Primitives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#native-mutexes" class="md-nav__link">
    <span class="md-ellipsis">
      Native mutexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pymutex" class="md-nav__link">
    <span class="md-ellipsis">
      PyMutex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#critical-sections" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Sections
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with global state
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dealing with global state">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#converting-global-state-to-thread-local-state" class="md-nav__link">
    <span class="md-ellipsis">
      Converting global state to thread local-state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-global-caches-thread-safe" class="md-nav__link">
    <span class="md-ellipsis">
      Making global caches thread-safe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-native-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe native libraries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe objects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lock-free-concurrent-programming-with-atomics" class="md-nav__link">
    <span class="md-ellipsis">
      Lock-free concurrent programming with atomics
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handling dependencies that donâ€™t support free-threading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setting up CI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing, Debugging, and Profiling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Testing, Debugging, and Profiling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validating thread safety with testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging thread safety issues
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thread_sanitizer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using Thread Sanitizer to validate and test thread safety
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../profiling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multithreaded Profiling with samply
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Frequently seen errors and how to fix them
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    More Resources
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declaring-free-threaded-support" class="md-nav__link">
    <span class="md-ellipsis">
      Declaring free-threaded support
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-the-free-threaded-cpython-interpreter-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Working with the free-threaded CPython interpreter runtime
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#porting-c-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Porting C Extensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locking-and-synchronization-primitives" class="md-nav__link">
    <span class="md-ellipsis">
      Locking and Synchronization Primitives
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Locking and Synchronization Primitives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#native-mutexes" class="md-nav__link">
    <span class="md-ellipsis">
      Native mutexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pymutex" class="md-nav__link">
    <span class="md-ellipsis">
      PyMutex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#critical-sections" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Sections
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with global state
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dealing with global state">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#converting-global-state-to-thread-local-state" class="md-nav__link">
    <span class="md-ellipsis">
      Converting global state to thread local-state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-global-caches-thread-safe" class="md-nav__link">
    <span class="md-ellipsis">
      Making global caches thread-safe
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-native-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe native libraries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe objects
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lock-free-concurrent-programming-with-atomics" class="md-nav__link">
    <span class="md-ellipsis">
      Lock-free concurrent programming with atomics
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="updating-extension-modules">Updating Extension Modules<a class="headerlink" href="#updating-extension-modules" title="Permanent link">#</a></h1>
<p>Here we are going to re-hash some of the same topics covered in the <a href="../porting/">previous
section</a> but with a focus on advice for updating native extension
modules, particularly modules relying directly on the CPython C API. The general
advice remains the same: identify supported multithreaded workflows, add
testing, and fix and identified thread safety issues. We will also describe how
to handle some common thread-unsafe patterns we have found in many extension
modules across the open source ecosystem.</p>
<h2 id="declaring-free-threaded-support">Declaring free-threaded support<a class="headerlink" href="#declaring-free-threaded-support" title="Permanent link">#</a></h2>
<p>Extension modules need to explicitly indicate they support running with the GIL
disabled, otherwise a warning is printed and the GIL is re-enabled at runtime
after importing a module that does not support the GIL.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:6"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><input id="__tabbed_1_5" name="__tabbed_1" type="radio" /><input id="__tabbed_1_6" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">C API</label><label for="__tabbed_1_2">Cython</label><label for="__tabbed_1_3">Pybind11</label><label for="__tabbed_1_4">nanobind</label><label for="__tabbed_1_5">PyO3</label><label for="__tabbed_1_6">f2py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>C or C++ extension modules using multi-phase initialization can specify the
<a href="https://docs.python.org/3/c-api/module.html#c.Py_mod_gil"><code>Py_mod_gil</code></a>
module slot like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">PyModuleDef_Slot</span><span class="w"> </span><span class="n">module_slots</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="cp">#ifdef Py_GIL_DISABLED</span>
<span class="w">    </span><span class="p">{</span><span class="n">Py_mod_gil</span><span class="p">,</span><span class="w"> </span><span class="n">Py_MOD_GIL_NOT_USED</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>The <code>Py_mod_gil</code> slot has no effect in the non-free-threaded build.</p>
<p>Extensions that use single-phase initialization need to call
<a href="https://docs.python.org/3/c-api/module.html#c.PyUnstable_Module_SetGIL"><code>PyUnstable_Module_SetGIL()</code></a>
in the module's initialization function:</p>
<div class="highlight"><pre><span></span><code><span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit__module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="cp">#ifdef Py_GIL_DISABLED</span>
<span class="w">    </span><span class="n">PyUnstable_Module_SetGIL</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">Py_MOD_GIL_NOT_USED</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>See <a href="https://cython.readthedocs.io/en/latest/src/userguide/freethreading.html">the Free threading
section</a>
in the Cython user guide for detailed recommendations. Keep in mind that
support for free-threaded Python in Cython code is currently considered
experimental, so suggestions are subject to change.</p>
<p>Starting with Cython 3.1.0 extension modules written in Cython can declare
free-threaded support using the
<a href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives"><code>freethreading_compatible</code></a>
compiler directive.</p>
<p>You can do this in one of
<a href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#how-to-set-directives">several ways</a>,
e.g., in a source file:</p>
<div class="highlight"><pre><span></span><code><span class="c"># cython: freethreading_compatible=True</span>
</code></pre></div>
<p>Or by passing the directive when invoking the <code>cython</code> executable:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cython<span class="w"> </span>-X<span class="w"> </span><span class="nv">freethreading_compatible</span><span class="o">=</span>True
</code></pre></div>
<p>Or via a build system specific way of passing directives to Cython.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Here are a few examples of how to globally enable the directive in a few popular
build systems:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">setuptools</label><label for="__tabbed_2_2">Meson</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>When using setuptools, you can pass the <code>compiler_directives</code> keyword argument
to <code>cythonize</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">Cython.Compiler.Version</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">cython_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">Version</span>

<span class="n">compiler_directives</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">cython_version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.1.0&quot;</span><span class="p">):</span>
    <span class="n">compiler_directives</span><span class="p">[</span><span class="s2">&quot;freethreading_compatible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span>
        <span class="n">extensions</span><span class="p">,</span>
        <span class="n">compiler_directives</span><span class="o">=</span><span class="n">compiler_directives</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>When using Meson, you can add the directive to the <code>cython_args</code> you're
passing to <code>py.extension_module</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vm">meson</span><span class="p">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="s">&#39;cython&#39;</span><span class="p">)</span>

<span class="n">cython_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="k">if</span><span class="w"> </span><span class="n">cy</span><span class="p">.</span><span class="n">version</span><span class="p">().</span><span class="n">version_compare</span><span class="p">(</span><span class="s">&#39;&gt;=3.1.0&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="n">cython_args</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;-Xfreethreading_compatible=True&#39;</span><span class="p">]</span>
<span class="k">endif</span>

<span class="n">py</span><span class="p">.</span><span class="n">extension_module</span><span class="p">(</span><span class="s">&#39;modulename&#39;</span>
<span class="w">    </span><span class="s">&#39;source.pyx&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">cython_args</span><span class="p">:</span><span class="w"> </span><span class="n">cython_args</span><span class="p">,</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">)</span>
</code></pre></div>
<p>You can also globally add the directive for all Cython extension modules:</p>
<div class="highlight"><pre><span></span><code><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vm">meson</span><span class="p">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="s">&#39;cython&#39;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="n">cy</span><span class="p">.</span><span class="n">version</span><span class="p">().</span><span class="n">version_compare</span><span class="p">(</span><span class="s">&#39;&gt;=3.1.0&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">add_project_arguments</span><span class="p">(</span><span class="s">&#39;-Xfreethreading_compatible=true&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">language</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cython&#39;</span><span class="p">)</span>
<span class="k">endif</span>
</code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>C++ extension modules making use of <code>pybind11</code> can easily declare support for
running with the GIL disabled via the
<a href="https://pybind11.readthedocs.io/en/stable/reference.html#_CPPv4N7module_23create_extension_moduleEPKcPKcP10module_def16mod_gil_not_used"><code>gil_not_used</code></a>
argument to <code>create_extension_module</code>. Example:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/pybind11.h&gt;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">pybind11</span><span class="p">;</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">mod_gil_not_used</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>C++ extension modules making use of <code>nanobind</code> can declare support for
running with the GIL disabled by passing the
<a href="https://nanobind.readthedocs.io/en/latest/free_threaded.html#opting-in"><code>FREE_THREADED</code></a>
argument to the <code>nanobind_add_module</code> CMake target command. Example:</p>
<div class="highlight"><pre><span></span><code><span class="nb">nanobind_add_module</span><span class="p">(</span>
<span class="w">  </span><span class="s">my_ext</span><span class="w">                   </span><span class="c"># Target name</span>
<span class="w">  </span><span class="s">FREE_THREADED</span><span class="w">            </span><span class="c"># Opt into free-threading</span>
<span class="w">  </span><span class="s">my_ext.h</span><span class="w">                 </span><span class="c"># Source code files below</span>
<span class="w">  </span><span class="s">my_ext.cpp</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>If you use the CPython C API in Rust via <a href="https://pyo3.rs">PyO3</a>, then you
can follow the <a href="https://pyo3.rs/latest/free-threading.html">PyO3 Guide
section</a> on supporting
free-threaded Python. You must also update your extension to at least
version 0.23.</p>
<p>You should write multithreaded tests of any code you expose to Python. See
our guide on <a href="../testing/#fixing-thread-unsafe-tests">updating test suites</a> for
more details. You should fix any thread safety issues you discover while
running multithreaded tests.</p>
<p>As of PyO3 0.23, PyO3 enforces Rust's borrow checking rules at
runtime and may produce runtime panics if you simultaneously mutably borrow
data in more than one thread. You may want to consider storing state in using
atomic data structures, with mutexes or locks, or behind <code>Arc</code>
pointers.</p>
<p>Once you are satisfied the Python modules defined by your rust crate are
thread safe, you can pass <code>gil_used = false</code> to the <a href="https://docs.rs/pyo3/latest/pyo3/attr.pymodule.html"><code>pymodule</code>
macro</a>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[pymodule(gil_used = false)]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">my_module</span><span class="p">(</span><span class="n">py</span><span class="p">:</span><span class="w"> </span><span class="nc">Python</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Bound</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">PyModule</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">PyResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div>
<p>If you define any modules procedurally by manually creating a <code>PyModule</code>
struct without using the <code>pymodule</code> macro, you can call
<a href="https://docs.rs/pyo3/latest/pyo3/prelude/trait.PyModuleMethods.html#tymethod.gil_used"><code>PyModuleMethods::gil_used</code></a>
after instantiating the module.</p>
<p>If you use the <code>pyo3-ffi</code> crate and/or <code>unsafe</code> FFI calls to call directly into the C
API, then see the section on porting C extensions in this guide as well as
the PyO3 source code.</p>
</div>
<div class="tabbed-block">
<p>Starting with NumPy 2.1.0, extension modules containing f2py-wrapped
Fortran code can declare they are thread-safe and support free-threading
using the
<a href="https://numpy.org/devdocs/f2py/usage.html#extension-module-construction"><code>--freethreading-compatible</code></a>
command-line argument:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>numpy.f2py<span class="w"> </span>-c<span class="w"> </span>code.f<span class="w"> </span>-m<span class="w"> </span>my_module<span class="w"> </span>--freethreading-compatible
</code></pre></div>
</div>
</div>
</div>
<p>If you publish binaries and have downstream libraries that depend on your
library, we suggest adding support as described above and uploading nightly wheels
as soon as basic support for the free-threaded build is established in the
development branch. This will ease the work of libraries that depend on yours
to also add support for the free-threaded build.</p>
<h2 id="working-with-the-free-threaded-cpython-interpreter-runtime">Working with the free-threaded CPython interpreter runtime<a class="headerlink" href="#working-with-the-free-threaded-cpython-interpreter-runtime" title="Permanent link">#</a></h2>
<p>Many people are surprised to learn that almost all native extensions written
with the GIL-enabled build in mind compile and run with minimal changes on the
free-threaded build. They often ask questions like, "if there is no GIL, doesn't
that mean there's no need to call e.g. <code>PyGilState_Ensure()</code> before calling into
the C API and no need to call <code>Py_BEGIN_ALLOW_THREADS</code> to release the GIL before
doing I/O or a long-running computation?". Bindings generators like Cython, PyO3,
or Pybind11 all also have syntax for explicitly acquiring and releasing the
GIL. Won't all this code need to change?</p>
<p>The answer is no. To understand, let's first take a look at the diagram below,
which illustrates a snapshot of the state of a multithreaded Python application
that has native extensions.</p>
<figure>
<p><img alt="GIL execution diagram" src="../assets/images/GIL_diagram.png" width="600" /></p>
<figcaption>
<p>A diagramatic snapshot of the state of a multithreaded Python
application running on the GIL-enabled interpreter</p>
</figcaption>
</figure>
<p>In this diagram, each thread spindle symbol represents a thread that is running
code inside a native extension. The lock icon indicates whether the thread holds
the GIL - only one thread can acquire the GIL at a time, indicated by the
fastened lock on the thread calling into the CPython C API. The bottom row of
symbols indicates what work each thread is doing. You can see that even with
the GIL it is possible to get multithreaded parallelism, so long as there are
threads that do not have the GIL acquired and are not waiting to acquire the
GIL. Usually, this means a thread is doing I/O or a long-running calculation
that does not need any state or functionality from the CPython runtime.</p>
<p>In addition to the lock icon indicating whether the GIL is acquired, each thread
icon is either plugged in or unplugged from the interpreter runtime, indicating
it has an attached or detached thread state. In the GIL-enabled build, only
one thread can have an attached thread state and hold the GIL, while all
other unplugged threads wait for the GIL to be released.</p>
<p>In the free-threaded build the GIL is disabled but threads can still either have
attached or detached thread states. As in the GIL-enabled build, only attached
threads can use interpreter state but, because there is no GIL, many threads can
simultaneously call into the CPython C API.</p>
<p>The state of a running free-threaded application is illustrated in the diagram below.</p>
<figure>
<p><img alt="free-threaded execution diagram" src="../assets/images/free_threaded_diagram.png" width="600" /></p>
<figcaption>
<p>A diagramatic snapshot of the state of a multithreaded Python
application running on the free-threaded-enabled interpreter</p>
</figcaption>
</figure>
<p>In the free-threaded build, the GIL is disabled, so this diagram doesn't have lock
icons. Because there is no GIL, threads do not need to wait to acquire it, and
multiple threads can simultaneously call into the CPython C API.</p>
<p>The icons indicating whether threads are attached or detached are still
present. As discussed above, this is because it is still necessary to explicitly
attach and detach from the runtime in the free-threaded build, despite the fact
that there isn't a GIL.</p>
<p>You might wonder why it's still necessary to detach from the runtime when doing
I/O or a long-running native calculation. This is because there are still times
when the interpreter needs to globally synchronize the state of all threads. For
example, the free-threaded interpreter uses a stop-the-world garbage collection
scheme, which requires all threads to be detached from the runtime before it can
start. If you don't explicitly detach before doing a long-running operation that
does not require the runtime, the interpreter may be blocked on running the
garbage collector or doing any other operation that requires a globally
consistent view of all threads.</p>
<figure>
<p><img alt="Attach and detach from the runtime diagram" src="../assets/images/attach-detach-gil.png" width="600" /></p>
<figcaption>
<p>Attaching and detaching from the runtime uses the same
code as in the GIL-enabled build</p>
</figcaption>
</figure>
<p>As illustrated above, attaching and detaching from the runtime uses exactly the
same code in the free-threaded build as is used in the GIL-enabled build to
acquire and release the GIL. It is an unfortunate naming issue that
<code>PyGILState_Ensure</code> and <code>PyGILState_Release</code> has "<code>GIL</code>" in the name of the
function, despite the lack of a GIL on the free-threaded build. It's likely that
the C API in future Python version will fix this naming issue.</p>
<p>Hopefully you now have a better mental model for how native code interacts with
the CPython interpreter runtime in the free-threaded build and how it is similar
to what happens on the GIL-enabled build, and what exactly it means for multiple
threads to simultaneously execute Python code.</p>
<p>You might also see how extension modules written assuming that Python can call
into the extension in one thread at a time might lead to problematic
thread-unsafe behavior. Doubly so now that more than one Python thread can
simultaneously access any state stored in the extension in the free-threaded
build.</p>
<h2 id="porting-c-extensions">Porting C Extensions<a class="headerlink" href="#porting-c-extensions" title="Permanent link">#</a></h2>
<p>The CPython C API exposes the <code>Py_GIL_DISABLED</code> macro in the free-threaded
build. You can use it to enable low-level code that only runs under the
free-threaded build, isolating possibly performance-impacting changes to the
free-threaded build:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifdef Py_GIL_DISABLED</span>
<span class="c1">// free-threaded specific code goes here</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef Py_GIL_DISABLED</span>
<span class="c1">// code for gil-enabled builds goes here</span>
<span class="cp">#endif</span>
</code></pre></div>
<h2 id="locking-and-synchronization-primitives">Locking and Synchronization Primitives<a class="headerlink" href="#locking-and-synchronization-primitives" title="Permanent link">#</a></h2>
<h3 id="native-mutexes">Native mutexes<a class="headerlink" href="#native-mutexes" title="Permanent link">#</a></h3>
<p>If your extension is written in C++, Rust, or another modern language that
exposes locking primitives in the standard library, you should consider using
the locking primitives provided by your language or framework to add locks when
needed.</p>
<p>If you need to call arbitrary Python code while the lock is held, care
should be taken to avoid creating deadlocks with the GIL on the GIL-enabled
build.</p>
<h3 id="pymutex"><code>PyMutex</code><a class="headerlink" href="#pymutex" title="Permanent link">#</a></h3>
<p>For C code or C-like C++ code, the CPython 3.13 C API exposes
<a href="https://docs.python.org/3/c-api/init.html#c.PyMutex"><code>PyMutex</code></a>, a
high-performance locking primitive that supports static allocation. As of
CPython 3.13, the mutex requires only one byte for storage, but future versions
of CPython may change that, so you should not rely on the size of <code>PyMutex</code> in
your code.</p>
<p>You can use <code>PyMutex</code> in both the free-threaded and GIL-enabled build of Python
3.13 or newer. <code>PyMutex</code> is hooked into the CPython runtime, so that if a thread
tries to acquire the mutex and ends up blocked, garbage collection can still
proceed and, in the GIL-enabled build, the blocked thread releases the GIL,
allowing other threads to continue running. This implies that it is impossible
to create a deadlock between a <code>PyMutex</code> and the GIL. For this reason, it is not
necessary to add code for the GIL-enabled build to ensure the GIL is released
before acquiring a <code>PyMutex</code>. If you do not call into the CPython C API while
holding the lock, <code>PyMutex</code> has no special advantages over other mutexes, besides
low-level details like performance or the size of the mutex object in memory.</p>
<p>See the section on <a href="./#dealing-with-thread-unsafe-native-libraries">dealing with thread-unsafe low-level
libraries</a>
below for an example using PyMutex to lock around a thread-unsafe C library.</p>
<h3 id="critical-sections">Critical Sections<a class="headerlink" href="#critical-sections" title="Permanent link">#</a></h3>
<p>Python 3.13 or newer also offers a <a href="https://docs.python.org/3/c-api/init.html#python-critical-section-api">critical section
API</a> that
is useful for locking either a single object or a pair of objects during a
low-level operation. The critical section API is intended to provide weaker, but
still useful locking guarantees compared to directly locking access to an object
using a mutex. This provides similar guarantees to the GIL and avoids
the risk of deadlocks introduced by locking individual objects.</p>
<p>The main difference compared with using a per-object lock is that active
critical sections are suspended if a thread calls <code>PyEval_SaveThread</code> (e.g. when
the GIL is released on the GIL-enabled build), and then restored when the thread
calls <code>PyEval_RestoreThread</code> (e.g. when the GIL is re-acquired on the
GIL-enabled build). This means that while the critical sections are suspended,
it's possible for any thread to re-acquire a thread state and mutate the locked
object. This can also happen with the GIL, since the GIL is a re-entrant lock,
and extensions are allowed to recursively release and acquire it in an
interleaved manner.</p>
<p>Critical sections are most useful when implementing the low-level internals of a
custom object that you fully control. You can apply critical sections around
modification of internal state to effectively serialize access to that state.</p>
<p>See the section below on <a href="./#dealing-with-thread-unsafe-objects">dealing with thread-unsafe
objects</a> for an example using
the critical section API.</p>
<h2 id="dealing-with-global-state">Dealing with global state<a class="headerlink" href="#dealing-with-global-state" title="Permanent link">#</a></h2>
<p>Many CPython C extensions make strong assumptions about the GIL. For example,
before NumPy 2.1.0, the C code in NumPy made extensive use of C static global
variables for storing settings, state, and caches. With the GIL, it is possible
for Python threads to produce non-deterministic results from a calculation, but
it is not possible for two C threads to simultaneously see the state of the C
global variables, so no data races are possible.</p>
<p>In free-threaded Python, global state like this is no longer safe against data
races and undefined behavior in C code. A cache of <code>PyObject</code> pointers stored in
a C global array can be overwritten simultaneously by multiple Python threads,
leading to memory corruption and segfaults.</p>
<h3 id="converting-global-state-to-thread-local-state">Converting global state to thread local-state<a class="headerlink" href="#converting-global-state-to-thread-local-state" title="Permanent link">#</a></h3>
<p>Often the easiest way to fix data races due to global state is to convert the
global state to thread local state.</p>
<p>Python and Cython code can make use of
<a href="https://docs.python.org/3/library/threading.html#thread-local-data"><code>threading.local</code></a>
to declare a thread-local Python object. C and C++ code can also use the
<a href="https://docs.python.org/3/c-api/init.html#thread-specific-storage-tss-api"><code>Py_tss API</code></a>
to store thread-local Python object references. <a href="https://peps.python.org/pep-0539">PEP
539</a> has more details about the <code>Py_tss</code> API.</p>
<p>Low-level C or C++ code can make use of the
<a href="https://en.cppreference.com/w/c/thread/thread_local"><code>thread_local</code></a> storage
specified by recent standard versions. Note that standardization of
thread-local storage in C has been slower than C++, so you may need to use
platform-specific definitions to declare variables with thread-local
storage. Also note that thread-local storage on MSVC has
<a href="https://learn.microsoft.com/en-us/cpp/parallel/thread-local-storage-tls?view=msvc-170#rules-and-limitations">caveats</a>,
and you should not use thread-local storage for anything besides statically
defined integers and pointers.</p>
<p>NumPy has a <a href="https://github.com/numpy/numpy/blob/b77d2c6cc214cdcde567f356688ebddb2a5e7c8c/numpy/_core/include/numpy/npy_common.h#L116-L128"><code>NPY_TLS</code>
macro</a>
in the <code>numpy/npy_common.h</code> header. While you can include the numpy header and
use <code>NPY_TLS</code> directly on NumPy 2.1 or newer, you can also add the definition
to your own codebase, along with some build configuration tests to test for the
correct definition to use.</p>
<h3 id="making-global-caches-thread-safe">Making global caches thread-safe<a class="headerlink" href="#making-global-caches-thread-safe" title="Permanent link">#</a></h3>
<p>Global caches are also a common source of thread safety issues. For example, if
a function requires an expensive intermediate result that only needs to be
calculated once, many C extensions store the result in a global variable. This
can lead to data races and memory corruption if more than one thread
simultaneously tries to fill the cache.</p>
<p>If the cache is not critical for performance, consider simply disabling the
cache in the free-threaded build:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">my_function_with_a_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">my_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifndef Py_GIL_DISABLED</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cache</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_expensive_result</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">my_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">my_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_expensive_result</span><span class="p">();</span>
<span class="cp">#endif;</span>
<span class="w">    </span><span class="c1">// use the cache</span>
<span class="p">}</span>
</code></pre></div>
<p>CPython holds a per-module lock during import. This lock can be released to
avoid deadlocks in unusual cases, but in most situations module initialization
happens exactly once per interpreter in one C thread. Modules using static
single-phase initialization can therefore set up per-module state in the
<code>PyInit</code> function without worrying about concurrent initialization of modules in
different threads. For example, you might set up a global static cache that is
read-only after module initialization like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit__module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// don&#39;t need to lock or do anything special</span>
<span class="w">    </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setup_cache</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// do rest of initialization</span>
<span class="p">}</span>
</code></pre></div>
<p>You can then read from <code>cache</code> at runtime in a context where you know the module
is initialized without worrying about whether or not the per-module static cache
is initialized.</p>
<p>If the cache is critical for performance, cannot be generated at import time,
but generally gets filled quickly after a program begins, then you will need to
use a single-initialization API to ensure the cache is only ever initialized
once. In C++, use
<a href="https://en.cppreference.com/w/cpp/thread/once_flag"><code>std::once_flag</code></a> or
<a href="https://en.cppreference.com/w/cpp/thread/call_once"><code>std::call_once</code></a>.</p>
<p>C does not have an equivalent portable API for single initialization. If you
need that, take a look at <a href="https://github.com/numpy/numpy/pull/26780">this NumPy
PR</a> for an example using atomic
operations and a global mutex.</p>
<p>If the cache is in the form of a data container, then you can lock access to
the container, like in the following example:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifdef Py_GIL_DISABLED</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyMutex</span><span class="w"> </span><span class="n">cache_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="cp">#define LOCK() PyMutex_Lock(&amp;cache_lock)</span>
<span class="cp">#define UNLOCK() PyMutex_Unlock(&amp;cache_lock)</span>
<span class="cp">#else</span>
<span class="cp">#define LOCK()</span>
<span class="cp">#define UNLOCK()</span>
<span class="cp">#endif</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">global_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">initialize_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// called during module initialization</span>
<span class="w">    </span><span class="n">global_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyDict_New</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">function_accessing_the_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOCK</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// use the cache</span>

<span class="w">    </span><span class="n">UNLOCK</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that, while the NumPy PR linked above uses <code>PyThread_type_lock</code>, that is
only because <code>PyMutex</code> was not part of the public Python C API at the time. We
recommend always using <code>PyMutex</code>. For pointers on how to do that, check
<a href="https://github.com/numpy/numpy/pull/27011">this NumPy PR</a> that ports all
<code>PyThread_type_lock</code> usages to <code>PyMutex</code>.</p>
</div>
<h2 id="dealing-with-thread-unsafe-native-libraries">Dealing with thread-unsafe native libraries<a class="headerlink" href="#dealing-with-thread-unsafe-native-libraries" title="Permanent link">#</a></h2>
<p>Many C, C++, and Fortran libraries are not written in a thread-safe manner. It
is still possible to call these libraries from free-threaded Python, but
wrappers must add appropriate locks to prevent undefined behavior.</p>
<p>There are two kinds of thread unsafe libraries: reentrant and non-reentrant. A
reentrant library generally will expose state as a struct that must be passed
to library functions. So long as the state struct is not shared between
threads, functions in the library can be safely executed simultaneously.</p>
<p>Wrapping reentrant libraries requires adding locking whenever the state struct
is accessed.</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">lib_state_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">low_level_library_state</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyMutex</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">lib_state_struct</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">call_library_function</span><span class="p">(</span><span class="n">lib_state_struct</span><span class="w"> </span><span class="o">*</span><span class="n">lib_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyMutex_Lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">library_function</span><span class="p">(</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="n">PyMutex_Unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">call_another_library_function</span><span class="p">(</span><span class="n">lib_state_struct</span><span class="w"> </span><span class="o">*</span><span class="n">lib_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyMutex_Lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">another_library_function</span><span class="p">(</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="n">PyMutex_Unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lib_state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>With this setup, if two threads call <code>library_function</code> and
<code>another_library_functions</code> simultaneously, one thread will block until the
other thread finishes, preventing concurrent access to <code>lib_state-&gt;state</code>.</p>
<p>Non-reentrant libraries provide an even weaker guarantee: threads cannot
call library functions simultaneously without causing undefined
behavior. Generally this is due to use of global static state in the
library. This means that non-reentrant libraries require a global lock:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">PyMutex</span><span class="w"> </span><span class="n">global_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">call_library_function</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyMutex_Lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">library_function</span><span class="p">(</span><span class="n">argument</span><span class="p">);</span>
<span class="w">    </span><span class="n">PyMutex_Unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Any other wrapped function needs similar locking around each call into the
library.</p>
<h2 id="dealing-with-thread-unsafe-objects">Dealing with thread-unsafe objects<a class="headerlink" href="#dealing-with-thread-unsafe-objects" title="Permanent link">#</a></h2>
<p>Similar to the section above, objects may need locking or atomics if they can
be concurrently modified from multiple threads. CPython 3.13
exposes a public C API that allows users to use the built-in
per-object locks.</p>
<p>For example the following code:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">do_modification</span><span class="p">(</span><span class="n">MyObject</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">modification_on_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Should be transformed to:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">do_modification</span><span class="p">(</span><span class="n">MyObject</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="n">Py_BEGIN_CRITICAL_SECTION</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modification_on_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="n">Py_END_CRITICAL_SECTION</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>A variant for locking two objects at once is also available. For more information
about <code>Py_BEGIN_CRITICAL_SECTION</code>, please see the
<a href="https://docs.python.org/3/c-api/init.html#python-critical-section-api">Python C API documentation on critical sections</a>.</p>
<h2 id="lock-free-concurrent-programming-with-atomics">Lock-free concurrent programming with atomics<a class="headerlink" href="#lock-free-concurrent-programming-with-atomics" title="Permanent link">#</a></h2>
<p>While a mutex offers a convenient API that ensures safe access, mutexes are also
blocking operations that might lead to contention if many threads compete to
acquire the mutex. Modern CPUs, operating systems, and programming languages
support a <a href="https://en.wikipedia.org/wiki/Memory_model_(programming)">memory
model</a> that allows
programmers to reason about multithreaded access to resources at the hardware
level. Correctly-written programs can ensure sequentially consistent access and
mutation for data that is simultaneously accessed by many threads. While the
possibility of doing such a thing is appealing, it is also technically fraught
and easy to write incorrect code using atomics, even in a memory-safe language
like Rust.</p>
<p>The author of this guide recommends <a href="https://marabos.nl/atomics/">"Rust Atomics and
Locks"</a> by Mara Bos as an introduction to lock-free
concurrent programming. While the book does use examples written in Rust, Rust
also shares the same memory model used in modern revisions of the C and C++
standard library. Rust also has a convenient API for working with atomics that
can be obscured by the more tricky APIs the C and C++ standard libraries
expose. <a href="http://www.cplusplusconcurrencyinaction.com/">"C++ Concurrency in
Action"</a> may also be a resource
for those who are more familiar with C or C++ syntax.</p>
<p>The C++ and Rust standard libraries both have widely-supported built-in support for
atomics. If your extension is written in C++ or Rust we encourage you to use the
standard library.</p>
<p>If you are updating an existing C library and would like to use atomic
operations, then we recommend using C standard library atomics. Recent versions
of both GCC and LLVM support C17 atomics. MSVC does not officially support C
atomics yet, but it is possible to enable experimental support for atomics using
the <code>/experimental:c11atomics</code> compiler flag in recent versions.</p>
<p>We also strongly recommend testing code that makes use of atomics under <a href="../thread_sanitizer/">Thread
Sanitizer</a> on more than one CPU architecture, particularly
CPU architectures that support weak ordering, like ARM CPUs. Certain kinds of
thread safety issues can only happen on ARM CPUs due to slightly different memory
semantics. Thread Sanitizer also has runtime options that can help determine
whether a bug is happening due to incorrect use of atomic operations.</p>
<p>For a worked example of how to enable atomics in a real-world project, see [PR</p>
<h1 id="2020httpsgithubcomnedbatcoveragepypull2020files-in-the">2020](https://github.com/nedbat/coveragepy/pull/2020/files) in the<a class="headerlink" href="#2020httpsgithubcomnedbatcoveragepypull2020files-in-the" title="Permanent link">#</a></h1>
<p><code>coveragepy</code> project, which enabled a lock-free boolean using atomic operations.</p>
<h2 id="cython-thread-safety">Cython thread safety<a class="headerlink" href="#cython-thread-safety" title="Permanent link">#</a></h2>
<p>See <a href="https://cython.readthedocs.io/en/latest/src/userguide/freethreading.html">the free-threading
section</a>
in the Cython user guide for recommendations from the Cython developers. In
particular, see the recommendations about <a href="https://cython.readthedocs.io/en/latest/src/userguide/freethreading.html#thread-safety">thread
safety</a>
and the <a href="https://cython.readthedocs.io/en/latest/src/userguide/freethreading.html#opinionated-suggestions">opinionated
suggestions</a>
for how to deal with thread safety in Cython extensions. At the time of writing,
Cython does not automatically ensure any significant level of thread safety, so
it is up to the author of a Cython extension to add locking or make use of
critical sections as needed to ensure thread safety.</p>
<p>It is normal for an extension to build without modification using Cython 3.1.0
or newer, but keep in mind that building or running without crashing does not
imply that code will also be thread-safe and deterministic when used in a
multithreaded context.</p>
<h2 id="cpython-c-api-usage">CPython C API usage<a class="headerlink" href="#cpython-c-api-usage" title="Permanent link">#</a></h2>
<p>In the free-threaded build it is possible for the reference count of an object
to change "underneath" a running thread when it is mutated by another
thread. This means that many APIs that assume reference counts cannot be
updated by another thread while it is running are no longer thread-safe. In
particular, C code returning "borrowed" references to Python objects in mutable
containers like lists may introduce thread safety issues. A borrowed reference
happens when a C API function does not increment the reference count of a
Python object before returning the object to the caller. "New" references are
safe to use until the owning thread releases the reference, as in non
free-threaded code.</p>
<p>Most direct uses of the CPython C API are thread-safe. There is no need to add
locking for scenarios that should be bugs in CPython. You can assume, for
example, that the initializer for a Python object can only be called by one
thread and the C-level implementation of a Python function can only be called on
one thread. Accessing the arguments of a Python function is thread-safe no
matter what C API constructs are used and no matter whether the reference is
borrowed or owned because two threads can't simultaneously call the same
function with the same arguments from the same Python-level context. Of course
it's possible to implement argument parsing in a thread-unsafe manner using
thread-unsafe C or C++ constructs, but it's not possible to do so using the
CPython C API.</p>
<h3 id="unsafe-apis-returning-borrowed-references">Unsafe APIs returning borrowed references<a class="headerlink" href="#unsafe-apis-returning-borrowed-references" title="Permanent link">#</a></h3>
<p>The <code>PyDict</code> and <code>PyList</code> APIs contain many functions returning borrowed
references to items in dicts and lists. Since these containers are mutable,
it's possible for another thread to delete the item from the container, leading
to the item being de-allocated while the borrowed reference is still
"alive". Even code like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_NewRef</span><span class="p">(</span><span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">list_object</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<p>Is not thread-safe, because in principle it's possible for the list item to be
de-allocated before <code>Py_NewRef</code> gets a chance to increment the reference count.</p>
<p>For that reason, you should inspect Python C API code to look for patterns
where a borrowed reference is returned to a shared, mutable data structure, and
replace uses of APIs like <code>PyList_GetItem</code> with APIs exposed by the CPython C
API returning strong references like <code>PyList_GetItemRef</code>. Not all usages are
problematic (see above) and we do not currently suggest converting all usages of
possibly unsafe APIs returning borrowed references to return new reference. This
would introduce unnecessary reference count churn in situations that are
thread-safe by construction and also likely introduce new reference counting
bugs in C or C++ code using the C API directly. However, many usages <em>are</em>
unsafe, and maintaining a borrowed reference to an objects that could be exposed
to another thread is unsafe.</p>
<p>A good starting place to find instances of this would be to look for usages of the
<a href="https://docs.python.org/3/howto/free-threading-extensions.html#borrowed-references">unsafe borrowed reference APIs mentioned in the free-threading compatibility docs</a>.</p>
<h3 id="adopt-pythoncapi-compat-to-use-new-c-api-functions">Adopt <code>pythoncapi-compat</code> to use new C API functions<a class="headerlink" href="#adopt-pythoncapi-compat-to-use-new-c-api-functions" title="Permanent link">#</a></h3>
<p>Rather than maintaining compatibility shims to use functions added to the C API
for Python 3.13 like <code>PyList_GetItemRef</code> while maintaining compatibility with
earlier Python versions, we suggest adopting the
<a href="https://github.com/python/pythoncapi-compat"><code>pythoncapi-compat</code></a> project as a
build-time dependency. This is a header-only library that can be vendored as
e.g. a git submodule and included to expose shims for C API functions on older
versions of Python that do not have implementations.</p>
<h3 id="some-low-level-apis-dont-enforce-locking">Some low-level APIs don't enforce locking<a class="headerlink" href="#some-low-level-apis-dont-enforce-locking" title="Permanent link">#</a></h3>
<p>Some low-level functions like <code>PyList_SET_ITEM</code> and <code>PyTuple_SET_ITEM</code> do not
do any internal locking and should only be used to build newly created
values. Do <em>not</em> use them to modify existing containers in the free-threaded
build.</p>
<h3 id="limited-api-support">Limited API support<a class="headerlink" href="#limited-api-support" title="Permanent link">#</a></h3>
<p>The free-threaded build does not support the limited CPython C API. If you
currently use the limited API to build wheels that do not depend on a specific
Python version, you will not be able to use it while shipping binaries for the
free-threaded build. In practice, the limited API is a subset of the full C API,
so your extension will build, you just cannot set <code>Py_LIMITED_API</code> at build
time. This also means that code inside <code>#ifdef Py_GIL_DISABLED</code> checks can use C
API constructs outside the limited API if you would like to do that, although
these uses will need to be removed once the free-threaded build gains support
for compiling with the limited API.</p>
<h1 id="dependencies-that-dont-support-free-threading">Dependencies that don't support free-threading<a class="headerlink" href="#dependencies-that-dont-support-free-threading" title="Permanent link">#</a></h1>
<p>See <a href="../dependencies/">our guidance for handling dependencies that don't support
free-threading</a>.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 8, 2025 12:21:50 UTC">October 8, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="July 10, 2024 10:09:59 UTC">July 10, 2024</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024- Quansight Labs & open source contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility/blob/main/LICENSE" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 10a3.04 3.04 0 0 1 3-3 3.04 3.04 0 0 1 3 3 3.04 3.04 0 0 1-3 3 3.04 3.04 0 0 1-3-3m3 9 4 1v-3.08A7.54 7.54 0 0 1 12 18a7.54 7.54 0 0 1-4-1.08V20m4-16a5.78 5.78 0 0 0-4.24 1.74A5.78 5.78 0 0 0 6 10a5.78 5.78 0 0 0 1.76 4.23A5.78 5.78 0 0 0 12 16a5.78 5.78 0 0 0 4.24-1.77A5.78 5.78 0 0 0 18 10a5.78 5.78 0 0 0-1.76-4.26A5.78 5.78 0 0 0 12 4m8 6a8 8 0 0 1-.57 2.8A7.8 7.8 0 0 1 18 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 0 1 4 10a7.68 7.68 0 0 1 2.33-5.64A7.73 7.73 0 0 1 12 2a7.73 7.73 0 0 1 5.67 2.36A7.68 7.68 0 0 1 20 10"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "header.autohide", "navigation.indexes"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>