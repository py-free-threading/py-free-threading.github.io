
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../testing/">
      
      
        <link rel="next" href="../faq/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Debugging thread safety issues - Python Free-Threading Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#debugging-thread-safety-issues" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Free-Threading Guide" class="md-header__button md-logo" aria-label="Python Free-Threading Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Free-Threading Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Debugging thread safety issues
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Free-Threading Guide" class="md-nav__button md-logo" aria-label="Python Free-Threading Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Python Free-Threading Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compatibility Status Tracking
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installing-cpython/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing Free-Threaded Python
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-gil-disabled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Python with the GIL Disabled
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../examples/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Usage Examples
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Usage Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/mandelbrot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mandelbrot Set Visualization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/monte-carlo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multithreaded Monte Carlo Simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/asyncio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Scraping with asyncio
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Porting Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Porting Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../porting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Porting Python Packages to Support Free-Threading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../porting-extensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Updating Extension Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handling dependencies that don’t support free-threading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setting up CI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Multithreaded Testing and Debugging
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Multithreaded Testing and Debugging
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validating thread safety with testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Debugging thread safety issues
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Debugging thread safety issues
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pytest-plugins-to-discover-concurrency-issues" class="md-nav__link">
    <span class="md-ellipsis">
      pytest plugins to discover concurrency issues
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pytest plugins to discover concurrency issues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repeated-test-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Repeated test execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-explicitly-concurrent-test-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Writing explicitly concurrent test cases
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-tests-that-depend-on-native-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging tests that depend on native calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging tests that depend on native calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cython-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      Cython debugging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-issues-in-cpython" class="md-nav__link">
    <span class="md-ellipsis">
      Detecting issues in CPython
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-cpython-and-foundational-packages-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling CPython and foundational packages with ThreadSanitizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiling CPython and foundational packages with ThreadSanitizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cpython_sanity-docker-images" class="md-nav__link">
    <span class="md-ellipsis">
      cpython_sanity docker images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-free-threaded-cpython-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compile free-threaded CPython with ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-numpy-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compile NumPy with ThreadSanitizer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-python-under-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Running Python under ThreadSanitizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running Python under ThreadSanitizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#useful-threadsanitizer-options" class="md-nav__link">
    <span class="md-ellipsis">
      Useful ThreadSanitizer options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-pytest-tests-under-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Running pytest tests under ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-addresssanitizer-to-detect-thread-safety-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Using AddressSanitizer to detect thread safety issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Frequently seen errors and how to fix them
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    More Resources
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pytest-plugins-to-discover-concurrency-issues" class="md-nav__link">
    <span class="md-ellipsis">
      pytest plugins to discover concurrency issues
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pytest plugins to discover concurrency issues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repeated-test-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Repeated test execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-explicitly-concurrent-test-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Writing explicitly concurrent test cases
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-tests-that-depend-on-native-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging tests that depend on native calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging tests that depend on native calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cython-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      Cython debugging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-issues-in-cpython" class="md-nav__link">
    <span class="md-ellipsis">
      Detecting issues in CPython
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-cpython-and-foundational-packages-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compiling CPython and foundational packages with ThreadSanitizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiling CPython and foundational packages with ThreadSanitizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cpython_sanity-docker-images" class="md-nav__link">
    <span class="md-ellipsis">
      cpython_sanity docker images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-free-threaded-cpython-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compile free-threaded CPython with ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compile-numpy-with-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Compile NumPy with ThreadSanitizer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-python-under-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Running Python under ThreadSanitizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running Python under ThreadSanitizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#useful-threadsanitizer-options" class="md-nav__link">
    <span class="md-ellipsis">
      Useful ThreadSanitizer options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-pytest-tests-under-threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Running pytest tests under ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-addresssanitizer-to-detect-thread-safety-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Using AddressSanitizer to detect thread safety issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="debugging-thread-safety-issues">Debugging thread safety issues<a class="headerlink" href="#debugging-thread-safety-issues" title="Permanent link">#</a></h1>
<p>Until now, the GIL has allowed developers to ignore C
safety issues when writing parallel programs, since the GIL ensured that
all thread execution was serialized, allowing for simultaneous access
to Python objects and state defined in the interpreter.</p>
<p>The new free-threaded model ensures that Python code access originating from
other Python code frames is safe and is guaranteed to not produce any major
interpreter crash, as opposed to unrestricted C code access, which can
present any of the common C thread-safety issues.</p>
<p>Usually, concurrency issues arise when two or more threads try to modify the
same value in memory. In Python, this commonly occurs when a class or function
defines native shared state, either via an attribute or a variable that can be
modified from native code in each thread execution scope.</p>
<p>The most common issues related to concurrency in the context of free-threaded
CPython extensions are either dirty reads/writes to global/shared C state,
unexpected behavior due to simultaneous access to C calls that are not
thread-safe, and finally, major runtime crashes due to memory allocation
issues and forbidden pointer lookups. While the first case depends on the
actual implementation of the algorithm/routine and may produce unintended
results, it would not cause a fatal crash of the interpreter, as opposed
to the last two cases.</p>
<p>In order to discover, handle and debug concurrency issues at large, there are
several strategies, which we will summarize next.</p>
<h2 id="pytest-plugins-to-discover-concurrency-issues">pytest plugins to discover concurrency issues<a class="headerlink" href="#pytest-plugins-to-discover-concurrency-issues" title="Permanent link">#</a></h2>
<p>As parallel testing has become a critical component to ensure compatibility
with free-threaded CPython, several community-led pytest plugins have been
implemented that attempt to smoke out issues by running all tests in a test
suite in a concurrent manner:</p>
<ul>
<li><a href="https://github.com/Quansight-Labs/pytest-run-parallel">pytest-run-parallel</a></li>
<li><a href="https://github.com/tonybaloney/pytest-freethreaded">pytest-freethreaded</a></li>
</ul>
<p>The advantage of using a pytest plugin as opposed to manually using the
<code>threading</code> and/or <code>concurrent.futures</code> modules mainly resides in their
ability to integrate with the ecosystem constructs like markers, fixtures,
skip and failure flags. For more information regarding the usage of these
libraries please refer to the documentation of each project.</p>
<h3 id="repeated-test-execution">Repeated test execution<a class="headerlink" href="#repeated-test-execution" title="Permanent link">#</a></h3>
<p>Given the non-deterministic nature of parallel execution, tests for code that
has a concurrency issue may still pass most of the time.
In order to more reliably reproduce a test failure under concurrency, we
recommend using <a href="https://github.com/pytest-dev/pytest-repeat">pytest-repeat</a>,
which enables the <code>--count</code> flag in the <code>pytest</code> command:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Setting PYTHON_GIL=0 ensures that the GIL is effectively disabled.</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>pytest<span class="w"> </span>-x<span class="w"> </span>-v<span class="w"> </span>--count<span class="o">=</span><span class="m">100</span><span class="w"> </span>test_concurrent.py
</code></pre></div>
<p>We advise to set <code>count</code> to <code>100</code> (or even larger if needed), in order to
ensure at least one concurrent clash event.</p>
<h2 id="writing-explicitly-concurrent-test-cases">Writing explicitly concurrent test cases<a class="headerlink" href="#writing-explicitly-concurrent-test-cases" title="Permanent link">#</a></h2>
<p>It may be desirable to have tests using, e.g., <code>threading</code> or
<code>concurrent.futures</code> in your test suite in order to prevent adding
additional test dependencies or to test a particular subset of tests for
concurrency issues by default. The stdlib <code>threading</code> module defines several
low-level parallel primitives that can be used to test for concurrency,
while the <code>concurrent.futures</code> module provides higher-level constructs.</p>
<p>For example, consider a method <code>MyClass.call_unsafe</code> that has been flagged as
having concurrency issues since it mutates attributes of a shared object that
is accessed by multiple threads. We can write a test for it using either
<code>threading</code> or <code>concurrent.futures</code> primitives:</p>
<details>
<summary>Example using threading:</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="c1"># Library to test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mylib</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyClass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_call_unsafe_concurrent_threading</span><span class="p">():</span>
    <span class="c1"># Defines a thread barrier that will be spawned before parallel execution</span>
    <span class="c1"># this increases the probability of concurrent access clashes.</span>
    <span class="n">n_threads</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">barrier</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Barrier</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>

    <span class="c1"># This object will be shared by all the threads.</span>
    <span class="n">cls_instance</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">():</span>
        <span class="c1"># Ensure that all threads reach this point before concurrent execution.</span>
        <span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cls_instance</span><span class="o">.</span><span class="n">call_unsafe</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Spawn n threads that call call_unsafe concurrently.</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">):</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">closure</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># Do something about the results</span>
    <span class="k">assert</span> <span class="n">check_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

</details>

<details>
<summary>Example using concurrent.futures:</summary>

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="c1"># Library to test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mylib</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyClass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_call_unsafe_concurrent_pool</span><span class="p">():</span>
    <span class="c1"># Defines a thread barrier that will be spawned before parallel execution</span>
    <span class="c1"># this increases the probability of concurrent access clashes.</span>
    <span class="n">n_threads</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">barrier</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Barrier</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>

    <span class="c1"># This object will be shared by all the threads.</span>
    <span class="n">cls_instance</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">():</span>
        <span class="c1"># Ensure that all threads reach this point before concurrent execution.</span>
        <span class="n">barrier</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cls_instance</span><span class="o">.</span><span class="n">call_unsafe</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>

    <span class="c1"># Do something about the results</span>
    <span class="k">assert</span> <span class="n">check_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

</details>

<h2 id="debugging-tests-that-depend-on-native-calls">Debugging tests that depend on native calls<a class="headerlink" href="#debugging-tests-that-depend-on-native-calls" title="Permanent link">#</a></h2>
<p>If your code has native dependencies, either via C/C++ or Cython, <code>gdb</code>
(or <code>lldb</code>) can be used as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Setting PYTHON_GIL=0 ensures that the GIL is effectively disabled.</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python<span class="w"> </span>my_program.py<span class="w"> </span>--args<span class="w"> </span>...

<span class="c1"># To test under pytest</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-x<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;test_here.py::TestClass::test_method&quot;</span>

<span class="c1"># Using LLDB (under LLVM/clang)</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>lldb<span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>python<span class="k">)</span><span class="w"> </span>my_program.py

<span class="c1"># Using LLDB (and pyenv)</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>lldb<span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>pyenv<span class="w"> </span>which<span class="w"> </span>python<span class="k">)</span><span class="w"> </span><span class="k">$(</span>pyenv<span class="w"> </span>which<span class="w"> </span>pytest<span class="k">)</span><span class="w"> </span>-x<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;test_here.py::TestClass::test_method&quot;</span>
</code></pre></div>
<p>When Python is run under <code>gdb</code>, several Python integration commands will be
available, such commands start with the <code>py-</code> prefix. For instance, the <code>py-bt</code>
allows to obtain a Python interpreter backtrace whenever the debugger hits a native
frame, this allows to improve the tracking of execution between Python and native
frames<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<p>For more information about <code>gdb</code> and <code>lldb</code> commands, we encourage reading
the <a href="https://lldb.llvm.org/use/map.html">GDB to LLDB command map</a> page in the
official LLVM docs.</p>
<h3 id="cython-debugging">Cython debugging<a class="headerlink" href="#cython-debugging" title="Permanent link">#</a></h3>
<p>Since Cython produces intermediate C/C++ sources that then are compiled into native
code, stepping through may get difficult if done solely from the C source file.
In order to get through such difficulty, Cython includes the <code>cygdb</code> extension,
which enables <code>gdb</code> to go through large sections of C code that are equivalent to
a single Cython declaration.</p>
<p>Enabling <code>cygdb</code> requires the compilation of Cython sources with the <code>--gdb</code>
flag. After the sources are compiled and linked, it can be used as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># For example, running the tests of scikit-image.</span>
<span class="c1"># build/cp313td/ contains the trace files generated by Cython to be compatible</span>
<span class="c1"># with cygdb</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>cygdb<span class="w"> </span>build/cp313td/<span class="w"> </span>--<span class="w"> </span>--args<span class="w"> </span>python<span class="w"> </span>-m<span class="w">  </span>pytest<span class="w"> </span>-x<span class="w"> </span>-v<span class="w"> </span>skimage/
</code></pre></div>
<p>Since <code>cygdb</code> requires the Python interpreter version used to compile <code>gdb</code>
to match the one to be used during the execution of the script, recompiling <code>gdb</code>
will be necessary in order to ensure the most complete debugging experience.
We recommend the <code>gdb</code> <a href="https://www.linuxfromscratch.org/blfs/view/svn/general/gdb.html">compilation instructions</a>
provided by the Linux from scratch project.</p>
<p><code>cygdb</code> defines a set of commands prefixed by <code>cy</code> that replace the usual <code>gdb</code>
commands. For example <code>cy run</code> will start the program with the Cython debugging
extensions enabled, <code>cy break</code> will define a breakpoint on a function with the
Cython definition name, <code>cy next</code> will step over a Cython line, which is equivalent
to several lines in the produced C code.</p>
<h3 id="detecting-issues-in-cpython">Detecting issues in CPython<a class="headerlink" href="#detecting-issues-in-cpython" title="Permanent link">#</a></h3>
<p>If a debugging session suggests that an error/bug is incoming from CPython,
we recommend installing a debug instance. The easiest way to accomplish this
is via <code>pyenv</code>:</p>
<div class="highlight"><pre><span></span><code>pyenv<span class="w"> </span>install<span class="w"> </span>--debug<span class="w"> </span>--keep<span class="w"> </span><span class="m">3</span>.13.1
</code></pre></div>
<p>This command will not only install a debug distribution of CPython, but also
will ensure that the source files are kept as well, such files will be loaded
by <code>gdb</code>/<code>lldb</code> at the moment of debugging. For more information regarding
CPython installation sources, please visit the
<a href="../installing-cpython/">Installing a free-threaded Python</a> page.</p>
<h2 id="compiling-cpython-and-foundational-packages-with-threadsanitizer">Compiling CPython and foundational packages with ThreadSanitizer<a class="headerlink" href="#compiling-cpython-and-foundational-packages-with-threadsanitizer" title="Permanent link">#</a></h2>
<p><a href="https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual">Thread sanitizer</a> (or TSan) helps
to detect C/C++ data races in concurrent systems. This tool can help to reveal free-threading
related bugs in CPython and foundational packages (e.g. <code>numpy</code>).
In this section we provide the commands to build a free-threading compatible
CPython interpreter and packages with ThreadSanitizer and other hints to discover
potential data races.</p>
<h3 id="cpython_sanity-docker-images"><code>cpython_sanity</code> docker images<a class="headerlink" href="#cpython_sanity-docker-images" title="Permanent link">#</a></h3>
<p>To ease working with thread sanitizer in projects that use Python, NumPy, and
SciPy, we have create a set of docker images that contain a pre-built Python
interpreter and common dependencies that can be tricky to build.</p>
<p>See <a href="https://github.com/nascheme/cpython_sanity">the <code>cpython_sanity</code>
repository</a> for more information
about how to use the docker images. Also see <a href="https://github.com/numpy/numpy/pull/28808/files">NumPy PR #28808</a>,
which adjusted NumPy TSAN CI to use the <code>ghcr.io/nascheme/numpy-tsan:3.14t-dev</code>
docker image instead of building Python from source, saving ten minutes of
compute time per CI run.</p>
<h3 id="compile-free-threaded-cpython-with-threadsanitizer">Compile free-threaded CPython with ThreadSanitizer<a class="headerlink" href="#compile-free-threaded-cpython-with-threadsanitizer" title="Permanent link">#</a></h3>
<ul>
<li>Clone the latest stable branch (<code>3.13</code>):</li>
</ul>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/python/cpython.git<span class="w"> </span>-b<span class="w"> </span><span class="m">3</span>.13
</code></pre></div>
<ul>
<li>Configure and build the interpreter. Below instructions are for Linux
    (Windows and macOS may require some changes). We skip the instructions on how
    to install the Clang compiler.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>cpython
<span class="nv">CC</span><span class="o">=</span>clang-18<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>clang++-18<span class="w"> </span>./configure<span class="w"> </span>--disable-gil<span class="w"> </span>--with-thread-sanitizer<span class="w"> </span>--prefix<span class="w"> </span><span class="nv">$PWD</span>/cpython-tsan
make<span class="w"> </span>-j<span class="w"> </span><span class="m">8</span>
make<span class="w"> </span>install
</code></pre></div>
<ul>
<li>To use the built Python interpreter:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Create a virtual environment:</span>
<span class="nv">$PWD</span>/cpython-tsan/bin/python3.13t<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>~/tsanvenv
<span class="c1"># Then activate it:</span>
<span class="nb">source</span><span class="w"> </span>~/tsanvenv/bin/activate

python<span class="w"> </span>-VV
<span class="c1"># Python 3.13.1 experimental free-threading build (tags/v3.13.1:06714517797, Dec 19 2024, 10:06:54) [Clang 18.1.3 (1ubuntu1)]</span>
<span class="nv">PYTHON_GIL</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import sys; print(sys._is_gil_enabled())&quot;</span>
<span class="c1"># False</span>

<span class="c1"># Exit the `cpython` folder (preparation for the next step below)</span>
<span class="nb">cd</span><span class="w"> </span>..
</code></pre></div>
<p>If you use pyenv, you can also enable a thread sanitizer build with <code>pyenv install</code> like so:</p>
<div class="highlight"><pre><span></span><code><span class="nv">CC</span><span class="o">=</span>/path/to/clang<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>/path/to/clang++<span class="w"> </span><span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">&quot;--with-thread-sanitizer&quot;</span><span class="w"> </span>pyenv<span class="w"> </span>install<span class="w"> </span><span class="m">3</span>.14t-dev
</code></pre></div>
<p>And then activate the build with e.g. <code>pyenv local 3.14t-dev</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On MacOS, you may see messages like this when you start Python:</p>
<div class="highlight"><pre><span></span><code>python(7027,0x1f6dfc240) malloc: nano zone abandoned due to inability to reserve vm space.
</code></pre></div>
<p>This message is being emitted by the MacOS malloc implementation. As
<a href="https://stackoverflow.com/questions/64126942/malloc-nano-zone-abandoned-due-to-inability-to-preallocate-reserved-vm-space">explained
here</a>,
this happens for any program compiled with ThreadSanitizer on MacOS and can
be safely ignored by setting the <code>MallocNanoZone</code> environment variable to
0. You should only set this in session you are running ThreadSanitizer
under, as this setting will slow down other programs that allocate memory.</p>
</div>
<h3 id="compile-numpy-with-threadsanitizer">Compile NumPy with ThreadSanitizer<a class="headerlink" href="#compile-numpy-with-threadsanitizer" title="Permanent link">#</a></h3>
<ul>
<li>Get the source code (for example, the <code>main</code> branch)</li>
</ul>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>https://github.com/numpy/numpy.git
</code></pre></div>
<ul>
<li>Install the build requirements:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>numpy
python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements/build_requirements.txt
</code></pre></div>
<ul>
<li>Build the package</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">CC</span><span class="o">=</span>clang-18<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>clang++-18<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-v<span class="w"> </span>.<span class="w"> </span>--no-build-isolation<span class="w"> </span>-Csetup-args<span class="o">=</span>-Db_sanitize<span class="o">=</span>thread
<span class="c1"># or with debug info</span>
<span class="c1"># CC=clang-18 CXX=clang++-18 python -m pip install -v . --no-build-isolation -Csetup-args=-Db_sanitize=thread -Csetup-args=-Dbuildtype=debugoptimized</span>
</code></pre></div>
<h2 id="running-python-under-threadsanitizer">Running Python under ThreadSanitizer<a class="headerlink" href="#running-python-under-threadsanitizer" title="Permanent link">#</a></h2>
<h3 id="useful-threadsanitizer-options">Useful ThreadSanitizer options<a class="headerlink" href="#useful-threadsanitizer-options" title="Permanent link">#</a></h3>
<ul>
<li>By default ThreadSanitizer reports warnings. To stop execution on ThreadSanitizer errors, use:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">TSAN_OPTIONS</span><span class="o">=</span><span class="nv">halt_on_error</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>test.py
</code></pre></div>
<p>See <a href="https://github.com/google/sanitizers/wiki/ThreadSanitizerFlags">the ThreadSanitizer documentation</a> for a full listing of options accepted by ThreadSanitizer.</p>
<ul>
<li>To add ThreadSanitizer suppressions (written in a file: <code>tsan-suppressions</code>):</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Let&#39;s show an example content of suppressions,</span>
<span class="c1"># more info: https://github.com/google/sanitizers/wiki/ThreadSanitizerSuppressions</span>
cat<span class="w"> </span><span class="nv">$PWD</span>/tsan-suppressions

race:llvm::RuntimeDyldELF::registerEHFrames
race:partial_vectorcall_fallback
race:dnnl_sgemm


<span class="nb">export</span><span class="w"> </span><span class="nv">TSAN_OPTIONS</span><span class="o">=</span><span class="s2">&quot;suppressions=</span><span class="nv">$PWD</span><span class="s2">/tsan-suppressions&quot;</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>test.py
</code></pre></div>
<h3 id="running-pytest-tests-under-threadsanitizer">Running pytest tests under ThreadSanitizer<a class="headerlink" href="#running-pytest-tests-under-threadsanitizer" title="Permanent link">#</a></h3>
<p>By default, pytest <a href="https://docs.pytest.org/en/stable/how-to/capture-stdout-stderr.html">captures all output from
tests</a>,
this means that you might only see output like <code>ThreadSanitizer: reported 2 warnings</code>, but with no accompanying report with details about the warning.</p>
<p>To ensure that pytest doesn't capture any output from ThreadSanitizer, you can
pass <code>-s</code> (short for <code>--show-capture</code>) to your pytest invocation.</p>
<p>Some authors of this guide have observed hangs running pytest with
<code>halt_on_error=1</code>. If you observe hangs, try setting <code>halt_on_error=0</code> in
TSAN_OPTIONS.</p>
<p>The <a href="https://github.com/pytest-dev/pytest-xdist">pytest-xdist</a> plugin can also
sometimes be problematic if a test runner happens to crash during
execution. While <code>pytest-xdist</code> does have some support for detecting crashed
worker, it is not foolproof and the authors of this guide have observed hangs on
CI due to pytest-xdist not properly handling a worker failing due to a ThreadSanitizer
error.</p>
<p>The <code>pytest-xdist</code> plugin also <a href="https://github.com/pytest-dev/pytest-xdist/issues/82">makes it impossible to obtain stdout from
a test runner</a>, so there
is no way to see ThreadSanitizer output if there is an issue. This can lead to hangs on CI
machines with no accompanying error report to explain the nature of the
hang. For that reason we suggest uninstalling <code>pytest-xdist</code> from your
environment to ensure it isn't used. If you need to use <code>pytest-xdist</code> to make
the tests complete in a reasonable amount of time, we suggest using
<a href="https://pypi.org/project/pytest-timeout/"><code>pytest-timeout</code></a> to ensure hung
tests eventually exit, particularly on CI.</p>
<p>ThreadSanitizer includes a check to ensure allocators never fail. This can lead to runtime
crashes if a test happens to try allocating a very large block of memory
specifically to ensure such an allocation does fail correctly. Set
<code>allocator_may_return_null=1</code> in <code>TSAN_OPTIONS</code> to avoid this.</p>
<p>If a ThreadSanitizer warning is detected, the exit code of the running process will be set
to a nonzero value (66, by default). If for some reason that is problematic in
your test suite then you can set <code>exitcode=0</code> in <code>TSAN_OPTIONS</code> to make ThreadSanitizer
quit "successfully" if a warning is detected. For example, you might set this if
a subprocess returning a nonzero exit code unexpectedly breaks a test.</p>
<p>You might also find that running your test suite is very slow under
ThreadSanitizer. Consider skipping tests that do not use threads, for example by only
testing files that import <code>threading</code> or
<code>concurrent.futures.ThreadPoolExecutor</code>. See <a href="https://github.com/numpy/numpy/blob/da268d45aab791023c8d953db6f4597019f770cb/.github/workflows/compiler_sanitizers.yml#L128">this NumPy CI
workflow</a>
that runs pytest on a subset of NumPy's tests. This will miss tests that spawn
threads in native code (e.g. with OpenMP or other threading primitives) or use
Python packages that spawn threads, but is a good option if your library doesn't
do that.</p>
<p>Altogether, a pytest invocation using ThreadSanitizer might look like:</p>
<div class="highlight"><pre><span></span><code>$ TSAN_OPTIONS=&#39;allocator_may_return_null=1 halt_on_error=1&#39; pytest -s
</code></pre></div>
<h3 id="using-addresssanitizer-to-detect-thread-safety-issues">Using AddressSanitizer to detect thread safety issues<a class="headerlink" href="#using-addresssanitizer-to-detect-thread-safety-issues" title="Permanent link">#</a></h3>
<p>Since ThreadSanitizer adds significant overhead to both the Python interpreter
and any native code compiled under ThreadSanitizer, many projects will be unable
to run their full test suite under ThreadSanitizer in CI.</p>
<p>For that reason, we also suggest setting up CI run for your full test suite
using <a href="https://github.com/google/sanitizers/wiki/addresssanitizer">AddressSanitizer</a> (or
ASan). AddressSanitizer will detect if there are any memory safety issues
triggered by multithreaded tests. While it will not detect data races that do
not lead to observable memory safety issues, it will detect races that could
lead to e.g. a segmentation fault and give precise debugging information about
the nature of the memory safety issue. A developer could then look more closely
at the issue using ThreadSanitizer outside of CI to more fully understand whether
data races contributed to the memory safety issue.</p>
<p>You can build Python with AddressSanitizer by passing <code>--with-address-sanitizer</code>
to the CPython configure script. You can build NumPy with AddressSanitizer by passing
<code>-Csetup-args=-Db_sanitize=address</code> as an argument to <code>pip install</code>.</p>
<p>Like ThreadSanitizer, AddressSanitizer also accepts a number of options to
control its behavior. See <a href="https://github.com/google/sanitizers/wiki/addresssanitizerflags">the
documentation</a>
for more details. Note that both the CPython interpreter and many extensions
have harmless memory leaks, so consider disabling the <a href="https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer">leak
sanitizer</a>
built into AddressSanitizer by setting <code>ASAN_OPTIONS="detect_leaks=0"</code>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This feature is not correctly working on <code>lldb</code> after CPython 3.12.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="May 9, 2025 19:22:13 UTC">May 9, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="July 25, 2024 08:12:34 UTC">July 25, 2024</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024- Quansight Labs & open source contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility/blob/main/LICENSE" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 10a3.04 3.04 0 0 1 3-3 3.04 3.04 0 0 1 3 3 3.04 3.04 0 0 1-3 3 3.04 3.04 0 0 1-3-3m3 9 4 1v-3.08A7.54 7.54 0 0 1 12 18a7.54 7.54 0 0 1-4-1.08V20m4-16a5.78 5.78 0 0 0-4.24 1.74A5.78 5.78 0 0 0 6 10a5.78 5.78 0 0 0 1.76 4.23A5.78 5.78 0 0 0 12 16a5.78 5.78 0 0 0 4.24-1.77A5.78 5.78 0 0 0 18 10a5.78 5.78 0 0 0-1.76-4.26A5.78 5.78 0 0 0 12 4m8 6a8 8 0 0 1-.57 2.8A7.8 7.8 0 0 1 18 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 0 1 4 10a7.68 7.68 0 0 1 2.33-5.64A7.73 7.73 0 0 1 12 2a7.73 7.73 0 0 1 5.67 2.36A7.68 7.68 0 0 1 20 10"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "header.autohide", "navigation.indexes"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>