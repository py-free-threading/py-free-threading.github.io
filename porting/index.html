
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../running-gil-disabled/">
      
      
        <link rel="next" href="../testing/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Porting Python Packages to Support Free-Threading - py-free-threading</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#porting-python-packages-to-support-free-threading" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="py-free-threading" class="md-header__button md-logo" aria-label="py-free-threading" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            py-free-threading
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Porting Python Packages to Support Free-Threading
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="py-free-threading" class="md-nav__button md-logo" aria-label="py-free-threading" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    py-free-threading
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python free-threading guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compatibility Status Tracking
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installing-cpython/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing Free-Threaded Python
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-gil-disabled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Python with the GIL Disabled
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Porting Python Packages to Support Free-Threading
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Porting Python Packages to Support Free-Threading
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-status-as-of-early-2025" class="md-nav__link">
    <span class="md-ellipsis">
      Current status (as of early 2025)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#suggested-plan-of-attack" class="md-nav__link">
    <span class="md-ellipsis">
      Suggested Plan of Attack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Suggested Plan of Attack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-and-document-thread-safety-guarantees" class="md-nav__link">
    <span class="md-ellipsis">
      Define and document thread safety guarantees
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety-of-pure-python-code" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Safety of Pure Python Code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-considerations-for-porting" class="md-nav__link">
    <span class="md-ellipsis">
      General considerations for porting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multithreaded-python-programming" class="md-nav__link">
    <span class="md-ellipsis">
      Multithreaded Python Programming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multithreaded Python Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dealing-with-mutable-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with mutable global state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converting-global-state-to-thread-local-state" class="md-nav__link">
    <span class="md-ellipsis">
      Converting global state to thread-local state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-mutable-global-caches-thread-safe-with-locking" class="md-nav__link">
    <span class="md-ellipsis">
      Making mutable global caches thread-safe with locking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raising-errors-under-shared-concurrent-use" class="md-nav__link">
    <span class="md-ellipsis">
      Raising errors under shared concurrent use.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dealing with thread-unsafe objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#third-party-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Third-party libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies-that-dont-support-free-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies that don't support free-threading
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validating thread safety with testing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../porting-extensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Updating Extension Modules
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handling dependencies that don’t support free-threading
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setting up CI
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging thread safety issues
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Frequently seen errors and how to fix them
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    More Resources
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-status-as-of-early-2025" class="md-nav__link">
    <span class="md-ellipsis">
      Current status (as of early 2025)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#suggested-plan-of-attack" class="md-nav__link">
    <span class="md-ellipsis">
      Suggested Plan of Attack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Suggested Plan of Attack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-and-document-thread-safety-guarantees" class="md-nav__link">
    <span class="md-ellipsis">
      Define and document thread safety guarantees
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-safety-of-pure-python-code" class="md-nav__link">
    <span class="md-ellipsis">
      Thread Safety of Pure Python Code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-considerations-for-porting" class="md-nav__link">
    <span class="md-ellipsis">
      General considerations for porting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multithreaded-python-programming" class="md-nav__link">
    <span class="md-ellipsis">
      Multithreaded Python Programming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multithreaded Python Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dealing-with-mutable-global-state" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with mutable global state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#converting-global-state-to-thread-local-state" class="md-nav__link">
    <span class="md-ellipsis">
      Converting global state to thread-local state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-mutable-global-caches-thread-safe-with-locking" class="md-nav__link">
    <span class="md-ellipsis">
      Making mutable global caches thread-safe with locking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raising-errors-under-shared-concurrent-use" class="md-nav__link">
    <span class="md-ellipsis">
      Raising errors under shared concurrent use.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-thread-unsafe-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thread-unsafe objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dealing with thread-unsafe objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#third-party-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Third-party libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies-that-dont-support-free-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies that don't support free-threading
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="porting-python-packages-to-support-free-threading">Porting Python Packages to Support Free-Threading<a class="headerlink" href="#porting-python-packages-to-support-free-threading" title="Permanent link">#</a></h1>
<p>This document discusses porting an existing Python package to support free-threading Python.</p>
<h2 id="current-status-as-of-early-2025">Current status (as of early 2025)<a class="headerlink" href="#current-status-as-of-early-2025" title="Permanent link">#</a></h2>
<p>Many Python packages, particularly packages relying on C
extension modules, do not consider multithreaded use or make strong
assumptions about the GIL providing sequential consistency in multithreaded
contexts. These packages will:</p>
<ul>
<li>fail to produce deterministic results on the free-threaded build</li>
<li>may, if there are C extensions involved, crash the interpreter in multithreaded use in ways that are impossible on the
    GIL-enabled build</li>
</ul>
<p>Attempting to parallelize many workflows using the Python
<a href="https://docs.python.org/3/library/threading.html">threading</a> module will not
produce any speedups on the GIL-enabled build, so thread safety issues that are possible even with the
GIL are not hit often since users do not make use of threading as much as other
parallelization strategies. This means many codebases have threading bugs that
up-until-now have only been theoretical or present in niche use cases. With
free-threading, many more users will want to use Python threads.</p>
<p>This means we must analyze Python codebases to identify supported and
unsupported multithreaded workflows and make changes to fix thread safety
issues. Extra care must be taken to address this need, particularly when using low-level C, C++, Cython, and Rust
code exposed to Python. Even pure Python codebases can exhibit
non-determinism and races in the free-threaded build that are either very
unlikely or impossible in the default configuration of the GIL-enabled build.</p>
<p>For a more in-depth look at the differences between the GIL-enabled and
free-threaded build, we suggest reading <a href="https://github.com/facebookincubator/ft_utils/blob/main/docs/ft_worked_examples.md">the <code>ft_utils</code>
documentation</a>
on this topic.</p>
<h2 id="suggested-plan-of-attack">Suggested Plan of Attack<a class="headerlink" href="#suggested-plan-of-attack" title="Permanent link">#</a></h2>
<p>Below, we outline a plan of attack for updating a Python project to support the
free-threaded build. Since the changes required in native extensions are more
substantial, we have split off the guide for porting extension modules into
<a href="../porting-extensions/">a subsequent section</a>.</p>
<h3 id="define-and-document-thread-safety-guarantees">Define and document thread safety guarantees<a class="headerlink" href="#define-and-document-thread-safety-guarantees" title="Permanent link">#</a></h3>
<p>Consider adding a section to your documentation clearly documenting the thread
safety guarantees of your library. Note any use of global state as well as
whether the mutable data structures exposed by your library support sequentially
consistent shared concurrent use. You should document any locks that you expect
might impact multithreaded scaling for realistic workflows. Encourage user
feedback, particularly for reports of thread-unsafe behavior in code that is
documented to be thread-safe, as well as reports of poor multithreaded scaling
in code that you expect to scale well.</p>
<p>You can indicate the level of support for free-threading in your library by
adding a <a href="https://pypi.org/classifiers/">trove classifier</a> to the metadata of
your package. The currently supported trove classifiers for this purpose are:</p>
<ul>
<li><code>Programming Language :: Python :: Free Threading :: 1 - Unstable</code></li>
<li><code>Programming Language :: Python :: Free Threading :: 2 - Beta</code></li>
<li><code>Programming Language :: Python :: Free Threading :: 3 - Stable</code></li>
<li><code>Programming Language :: Python :: Free Threading :: 4 - Resilient</code></li>
</ul>
<p>The numeric level of support in the classifier corresponds to the level of support. To give some guidance as to what that means:</p>
<ol>
<li>For experimentation and feedback only.</li>
<li>Free threaded usage is supported, but documentation of constraints and limitations may be incomplete.</li>
<li>Supported for production use, multithreaded use is tested, and thread safety issues are clearly documented.</li>
<li>Fully supported and fully thread safe.</li>
</ol>
<p>You can see how supporting the free-threaded build is not all all-or-nothing
thing. It is a perfectly valid choice to, for example, only support running on
the free-threaded build in effectively single-threaded contexts and not support
shared use of objects. It is then up to the users of your library to add locking
where appropriate or needed. The advantage of this choice is that it does not
force all consumers of your library to pay any cost associated with ensuring
thread safety.</p>
<h3 id="thread-safety-of-pure-python-code">Thread Safety of Pure Python Code<a class="headerlink" href="#thread-safety-of-pure-python-code" title="Permanent link">#</a></h3>
<p>The CPython interpreter protects you from low-level memory unsafety due to <a href="https://en.wikipedia.org/wiki/Race_condition#Data_race">data
races</a>. It does not
protect you from introducing thread safety issues due to <a href="https://en.wikipedia.org/wiki/Race_condition">race
conditions</a>. It is possible to
write algorithms that depend on the precise timing of threads completing
work. It is up to you as a user of multithreaded parallelism to ensure that
simultaneous reads and writes to the same Python variable are impossible.</p>
<p>Below we describe various approaches for improving the determinism of
multithreaded pure Python code. The correct approach will depend on exactly what
you are doing.</p>
<h3 id="general-considerations-for-porting">General considerations for porting<a class="headerlink" href="#general-considerations-for-porting" title="Permanent link">#</a></h3>
<p>Many projects assume the GIL serializes access to state shared between threads,
introducing the possibility of data races in native extensions and race
conditions that are impossible when the GIL is enabled.</p>
<p>We suggest focusing on safety and multithreaded scaling before single-threaded
performance.</p>
<p>Here's an example of this approach. If adding a lock to a global cache would harm
multithreaded scaling, and turning off the cache implies a small performance
hit, consider doing the simpler thing and disabling the cache in the
free-threaded build.</p>
<p>Single-threaded performance can always be improved later,
once you've established free-threaded support and hopefully improved test
coverage for multithreaded workflows.</p>
<p>NumPy, for example, decided <em>not</em> to add explicit locking to the ndarray object
and <a href="https://numpy.org/devdocs/reference/thread_safety.html#thread-safety">does not support mutating shared
ndarrays</a>. This
was a pragmatic choice given existing heavy multithreaded use of NumPy in the
GIL-enabled build and a desire to not introducing scaling bottlenecks in
existing workflows.</p>
<p>Eventually NumPy may need to offer explicitly thread-safe data structures, but
it is a valid choice to initially support free-threading while still exposing
possibly unsafe operations if users use the library unsafely.</p>
<p>For your libraries, we suggest to focus on thread safety issues that only occur
with the GIL disabled. Any non-critical pre-existing thread safety issues can be
dealt with later once the free-threaded build is used more. The goal for your
initial porting effort should be to enable further refinement and
experimentation by fixing issues that prevent using the library at all.</p>
<h2 id="multithreaded-python-programming">Multithreaded Python Programming<a class="headerlink" href="#multithreaded-python-programming" title="Permanent link">#</a></h2>
<p>The Python standard library offers a rich API for multithreaded
programming. This includes the <a href="https://docs.python.org/3/library/threading.html"><code>threading</code>
module</a>, which offers
relatively low-level locking and synchronization primitives, as well as the
<a href="https://docs.python.org/3/library/queue.html"><code>queue module</code></a> for safe
communication between threads, and the
<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor"><code>ThreadPoolExecutor</code></a>
high-level thread pool runner.</p>
<p>If you'd like to learn more about multithreaded Python programming in the
GIL-enabled build, Santiago Basulto's <a href="https://www.youtube.com/watch?v=18B1pznaU1o">tutorial from PyCon
2020</a> is a good place to start.</p>
<p>For a pedagogical introduction to multithreaded programming in free-threaded
Python, we suggest reading the
<a href="https://github.com/facebookincubator/ft_utils/blob/main/docs/index.md"><code>ft_utils</code></a>
documentation, particularly the section on <a href="https://github.com/facebookincubator/ft_utils/blob/main/docs/ft_worked_examples.md#understanding-the-global-interpreter-lock-gil-and-its-impact-on-multithreaded-python-programs">the impact of the global interpreter
lock on multithreaded Python
programs</a>. Many
pure Python operations are not atomic and are susceptible to race conditions, or
only appear to be thread-safe in the GIL-enabled build because of details of how
CPython releases the GIL in a round-robin fashion to allow threads to run.</p>
<h3 id="dealing-with-mutable-global-state">Dealing with mutable global state<a class="headerlink" href="#dealing-with-mutable-global-state" title="Permanent link">#</a></h3>
<p>The most common source of thread safety issues in Python packages is use of
global mutable state. Many projects use module-level or class-level caches to
speed up execution but do not envision filling the cache simultaneously from
multiple threads. See the <a href="../testing/">testing guide</a> for strategies to add
tests to detect problematic global state.</p>
<p>For example, the <code>do_calculation</code> function in the following module is not
thread-safe:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">internals</span><span class="w"> </span><span class="kn">import</span> <span class="n">_do_expensive_calculation</span>

<span class="n">global_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">do_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">global_cache</span><span class="p">:</span>
        <span class="n">global_cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">_do_expensive_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">global_cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
</code></pre></div>
<p>If <code>do_calculation</code> is called simultaneously in multiple threads, then it is
possible for at least two threads to see that <code>global_cache</code> doesn't have the
cached key and call <code>_do_expensive_calculation</code>. In some cases this is harmless,
but depending on the nature of the cache, this could lead to unnecessary network
access, resource leaks, or wasted unnecessary compute cost.</p>
<h3 id="converting-global-state-to-thread-local-state">Converting global state to thread-local state<a class="headerlink" href="#converting-global-state-to-thread-local-state" title="Permanent link">#</a></h3>
<p>One way of dealing with issues like this is to convert a shared global cache
into a thread-local cache. In this approach, each thread will see its own private
copy of the cache, making races between threads impossible. This approach makes
sense if having extra copies of the cache in each thread is not prohibitively
expensive or does not lead to excessive runtime network, CPU, or memory use.</p>
<p>In pure Python, you can create a thread-local cache using an instance of
<a href="https://docs.python.org/3/library/threading.html#thread-local-data">threading.local</a>. Each
thread will see independent versions of the thread-local object. You could
rewrite the above example to use a thread-local cache like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">internals</span><span class="w"> </span><span class="kn">import</span> <span class="n">_do_expensive_calculation</span>

<span class="n">local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="n">local</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">do_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
        <span class="n">local</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">_do_expensive_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">local</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
</code></pre></div>
<p>This wouldn't help a case where each thread having a copy of the cache would be
prohibitive, but it does fix possible issues with resource leaks issues due to
races filling a cache.</p>
<h3 id="making-mutable-global-caches-thread-safe-with-locking">Making mutable global caches thread-safe with locking<a class="headerlink" href="#making-mutable-global-caches-thread-safe-with-locking" title="Permanent link">#</a></h3>
<p>If a thread-local cache doesn't make sense, then you can serialize access to the
cache with a lock. A
<a href="https://en.wikipedia.org/wiki/Lock_(computer_science)">lock</a> provides exclusive
access to some resource by forcing threads to <em>acquire</em> a lock instance before
they can use the resource and <em>release</em> the lock when they are done. The lock
ensures that only one thread at a time can use the acquired lock - all other
threads <a href="https://en.wikipedia.org/wiki/Blocking_(computing)">block execution</a>
until the thread that holds the lock releases it, at which point only one thread
waiting to acquire the lock is allowed to run.</p>
<p>You could rewrite the above thread-unsafe example to be thread-safe using a lock
like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">internals</span><span class="w"> </span><span class="kn">import</span> <span class="n">_do_expensive_calculation</span>

<span class="n">cache_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">global_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">do_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">global_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">global_cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>

    <span class="n">cache_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">global_cache</span><span class="p">:</span>
        <span class="n">global_cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">_do_expensive_calculation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">cache_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">global_cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
</code></pre></div>
<p>Note that after acquiring the lock, we first check if the requested key
has been filled by another thread, to prevent unnecessary calls to
<code>_do_expensive_calculation</code> if another thread filled the cache while the thread
currently holding the lock was blocked on acquiring the lock. Also note that
<a href="https://docs.python.org/3/library/threading.html#threading.Lock.acquire"><code>Lock.acquire</code></a>
<em>must</em> be followed by a call to
<a href="https://docs.python.org/3/library/threading.html#threading.Lock.release"><code>Lock.release</code></a>,
calling <code>Lock.acquire()</code> recursively on the same lock leads to deadlocks. Also,
in general, it is possible to create a deadlock in any program with more than
one lock. Care must be taken to ensure that operations done while the lock is
held cannot lead to recursive calls or lead to a situation where a thread owning
the lock is blocked on acquiring a difference mutex. You do not need to worry
about deadlocking with the GIL in pure Python code, the interpreter will handle
that for you.</p>
<p>There is also
<a href="https://docs.python.org/3/library/threading.html#rlock-objects">threading.RLock</a>,
which provides a reentrant lock allowing threads to recursively acquire the same
lock.</p>
<h3 id="raising-errors-under-shared-concurrent-use">Raising errors under shared concurrent use.<a class="headerlink" href="#raising-errors-under-shared-concurrent-use" title="Permanent link">#</a></h3>
<p>Sometimes it's a programming error to share an object between threads. An
example might be a wrapper for a low-level C compression library that does not
support sharing compression contexts between threads. You could make it so users
see an error at runtime when they try to share a compression context like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CompressionContext</span><span class="p">:</span>
    <span class="n">lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">_LowLevelCompressionContext</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Concurrent use detected!&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
<p>This does require paying the cost of acquiring and releasing a mutex, but
because no thread ever blocks on acquiring the lock, this thread cannot
introduce hidden multithreaded scaling issues.</p>
<h2 id="dealing-with-thread-unsafe-objects">Dealing with thread-unsafe objects<a class="headerlink" href="#dealing-with-thread-unsafe-objects" title="Permanent link">#</a></h2>
<p>Mutability of objects is deeply embedded in the Python runtime and many tools freely
assign to or mutate data stored in a python object.</p>
<p>In the GIL-enabled build, in many cases, you can get away with mutating a shared
object safely. This is true so long as whatever mutation you are attempting to
do is fast enough that a thread switch is very unlikely to happen while you are
doing work.</p>
<p>In the free-threaded build there is no GIL to protect against mutation of state
living on a Python object that is shared between threads. Just like when we used
a lock to protect a global cache, we can also use a per-object lock to serialize
access to state stored in a Python object. Consider the following class:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaceyCounter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>Here we're simulating doing an in-place addition on an expensive function. A
real example might have a method that looks something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">do_some_expensive_calulation</span><span class="p">()</span>
</code></pre></div>
<p>If we run this example in a thread pool, you'll see that the answer you get will
vary randomly depending on the timing of the sleeps:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="n">counter</span> <span class="o">=</span> <span class="n">RaceyCounter</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">(</span><span class="n">counter</span><span class="p">):</span>
    <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>


<span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="n">tpe</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpe</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">closure</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
<p>On both the free-threaded and GIL-enabled build, you will see the output of this
script randomly vary.</p>
<p>We can ensure the above script has deterministic answers by adding a lock to our counter:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SafeCounter</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
<p>If you replace <code>RaceyCounter</code> with <code>SafeCounter</code> in the script above, it will
always output 1000.</p>
<p>Of course this introduces a scaling bottleneck when <code>SafeCounter</code> instances are
concurrently updated. It's possible to implement more optimized locking
strategies, but doing so requires knowledge of the problem.</p>
<h3 id="third-party-libraries">Third-party libraries<a class="headerlink" href="#third-party-libraries" title="Permanent link">#</a></h3>
<p>Both the <a href="https://github.com/facebookincubator/ft_utils"><code>ft_utils</code></a> and
<a href="https://github.com/dpdani/cereggii"><code>cereggii</code></a> libraries offer data structures
that add enhanced atomicity or improved multithreaded scaling compared with
standard library primitives.</p>
<h2 id="dependencies-that-dont-support-free-threading">Dependencies that don't support free-threading<a class="headerlink" href="#dependencies-that-dont-support-free-threading" title="Permanent link">#</a></h2>
<p>If one of your package's dependencies do not support free-threading, you might
be able to switch to a fork that does. Find more details in
<a href="../dependencies/">our guidance for handling dependencies that don't support free-threading</a>.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="May 13, 2025 19:37:47">May 13, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="July 10, 2024 10:09:59">July 10, 2024</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024- Quansight Labs & open source contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/Quansight-Labs/free-threaded-compatibility/blob/main/LICENSE" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 10a3.04 3.04 0 0 1 3-3 3.04 3.04 0 0 1 3 3 3.04 3.04 0 0 1-3 3 3.04 3.04 0 0 1-3-3m3 9 4 1v-3.08A7.54 7.54 0 0 1 12 18a7.54 7.54 0 0 1-4-1.08V20m4-16a5.78 5.78 0 0 0-4.24 1.74A5.78 5.78 0 0 0 6 10a5.78 5.78 0 0 0 1.76 4.23A5.78 5.78 0 0 0 12 16a5.78 5.78 0 0 0 4.24-1.77A5.78 5.78 0 0 0 18 10a5.78 5.78 0 0 0-1.76-4.26A5.78 5.78 0 0 0 12 4m8 6a8 8 0 0 1-.57 2.8A7.8 7.8 0 0 1 18 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 0 1 4 10a7.68 7.68 0 0 1 2.33-5.64A7.73 7.73 0 0 1 12 2a7.73 7.73 0 0 1 5.67 2.36A7.68 7.68 0 0 1 20 10"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "header.autohide"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>